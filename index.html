<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Archive Manager (Desktop)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; user-select: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .drag-target-hover { background-color: #eff6ff !important; border: 2px dashed #3b82f6 !important; transform: scale(1.02); }
        .drop-zone-active { background-color: #eff6ff; border-color: #3b82f6; transform: scale(1.01); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none z-20 shadow-sm px-6 flex justify-between items-center -webkit-app-region: drag">
        <div class="flex items-center gap-2">
            <span class="text-xl font-bold text-slate-700 tracking-tight">Archive<span class="text-blue-600">Pro</span></span>
            <span class="text-xs bg-indigo-600 text-white px-2 py-0.5 rounded font-medium">v1.0 Global</span>
        </div>
        
        <nav class="flex space-x-1 bg-slate-100 p-1 rounded-lg no-drag">
            <button onclick="switchTab('organizer')" id="nav-organizer" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-blue-700 bg-white shadow-sm">Organizer</button>
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Stats</button>
            <button onclick="switchTab('export')" id="nav-export" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Export</button>
        </nav>

        <div class="w-32 flex justify-end no-drag">
            <button onclick="fullReset()" class="text-xs text-red-400 hover:text-red-600 underline">Reset All Data</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- UPLOAD VIEW -->
        <div id="view-upload" class="absolute inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 transition-transform duration-500">
            <div class="bg-white p-10 rounded-2xl shadow-xl max-w-2xl w-full text-center border border-slate-100 relative">
                <div id="upload-ui">
                    <h1 class="text-3xl font-bold text-slate-800 mb-2">Import ChatGPT Archive</h1>
                    <p class="text-slate-500 mb-8">No saved data found.<br>Please drag & drop your <b>conversations.json</b> file.</p>
                    <div id="drop-zone" class="w-full h-48 border-2 border-dashed border-blue-200 rounded-xl transition-all flex flex-col items-center justify-center cursor-pointer group hover:bg-blue-50">
                        <input type="file" id="file-input" class="hidden" accept=".json">
                        <div class="pointer-events-none flex flex-col items-center">
                            <span class="text-4xl mb-2 group-hover:scale-110 transition-transform">üìÇ</span>
                            <span class="text-blue-600 font-medium">Drop File Here</span>
                        </div>
                    </div>
                </div>
                <div id="processing-ui" class="hidden flex flex-col items-center">
                    <div class="loader mb-4"></div>
                    <p class="text-slate-600">Analyzing and Categorizing...</p>
                    <p class="text-xs text-slate-400 mt-2">This happens locally on your machine.</p>
                </div>
            </div>
        </div>

        <!-- ORGANIZER VIEW -->
        <div id="view-organizer" class="hidden h-full flex flex-row">
            <div class="w-64 bg-white border-r border-slate-200 flex flex-col flex-none z-10">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h3 class="font-semibold text-slate-700">Categories</h3>
                    <button onclick="openCategoryModal()" class="text-blue-600 hover:bg-blue-100 p-1 rounded transition-colors" title="New Category">+</button>
                </div>
                <div id="category-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>
            <div class="flex-1 flex flex-col bg-slate-50/50 relative">
                <div class="h-14 bg-white border-b border-slate-200 flex items-center px-6 justify-between flex-none">
                    <div class="flex items-center gap-4">
                        <h2 id="current-category-title" class="text-lg font-bold text-slate-800">All Chats</h2>
                        <span id="current-count-badge" class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-mono">0</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openSmartRuleModal()" class="flex items-center gap-2 bg-white text-slate-700 px-3 py-1.5 rounded-md hover:bg-slate-50 border border-slate-300 shadow-sm text-sm"><span>ü§ñ</span> Smart Rule</button>
                        <input type="text" id="search-input" placeholder="Search..." class="pl-4 pr-4 py-1.5 border border-slate-300 rounded-md text-sm w-56 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div id="conversation-container" class="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 content-start"></div>
                <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 pointer-events-none">
                    <span class="text-4xl mb-2">üì≠</span><p>Empty Category</p>
                </div>
            </div>
        </div>

        <!-- EXPORT VIEW -->
        <div id="view-export" class="hidden h-full overflow-y-auto bg-slate-50 p-8">
             <div class="max-w-5xl mx-auto">
                <div class="bg-slate-800 rounded-xl shadow-md p-8 mb-8 text-white flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Export to Desktop</h2>
                        <p class="text-slate-300 mt-2">
                            Click the buttons below to create a folder on your Desktop.<br>
                            Each chat will be saved as an individual <b>.md (Markdown)</b> file, perfect for NotebookLM or Obsidian.
                        </p>
                    </div>
                    <div class="text-4xl">üóÇÔ∏è</div>
                </div>
                <div id="export-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="hidden h-full bg-slate-50 p-8">
             <div class="max-w-4xl mx-auto grid grid-cols-2 gap-8">
                 <div class="bg-white p-6 rounded shadow">
                     <h3 class="font-bold mb-4">Category Distribution</h3>
                     <div style="height:300px"><canvas id="pieChart"></canvas></div>
                 </div>
                 <div class="bg-white p-6 rounded shadow">
                     <h3 class="font-bold mb-4">Total Conversations</h3>
                     <div class="text-6xl font-bold text-blue-600 flex items-center justify-center h-48" id="total-stat">0</div>
                 </div>
             </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-smart-rule" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform scale-95 transition-transform duration-300" id="modal-content-rule">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Batch Organize Rule</h3>
            <p class="text-sm text-slate-500 mb-2">Move chats containing these words:</p>
            <input type="text" id="rule-keywords" placeholder="Keywords (e.g. java, python, error)" class="w-full px-3 py-2 border border-slate-300 rounded-lg mb-4">
            <p class="text-sm text-slate-500 mb-2">To this category:</p>
            <select id="rule-target-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg mb-6"></select>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('modal-smart-rule')" class="px-4 py-2 text-slate-600">Cancel</button>
                <button onclick="applySmartRule()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Apply Rule</button>
            </div>
        </div>
    </div>

    <div id="modal-category" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Add Category</h3>
            <input type="text" id="new-cat-name" placeholder="Category Name" class="w-full px-3 py-2 border border-slate-300 rounded-lg mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-category')" class="px-3 py-2 text-slate-500">Cancel</button>
                <button onclick="addNewCategory()" class="px-3 py-2 bg-blue-600 text-white rounded">Create</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[100]">‚úî Saved</div>

    <script>
        // --- ENGLISH KEYWORDS FOR AUTO-SORTING ---
        const KEYWORDS = {
            'Cinema & TV': ['movie', 'film', 'watch', 'director', 'script', 'actor', 'netflix', 'series', 'imdb', 'plot', 'scene', 'character', 'cinema', 'show', 'season', 'episode'],
            'Coding & Dev': ['code', 'python', 'javascript', 'html', 'css', 'react', 'api', 'error', 'debug', 'git', 'terminal', 'sql', 'database', 'json', 'node', 'npm', 'script', 'algorithm', 'app', 'web', 'site', 'stack', 'overflow', 'function', 'class'],
            'Legal': ['law', 'legal', 'court', 'case', 'attorney', 'lawyer', 'crime', 'contract', 'agreement', 'judge', 'prosecutor', 'rights', 'sue', 'regulation', 'clause'],
            'Finance': ['money', 'stock', 'market', 'invest', 'economy', 'dollar', 'crypto', 'bitcoin', 'bank', 'interest', 'credit', 'budget', 'salary', 'tax', 'revenue', 'cost', 'price'],
            'Health & Life': ['diet', 'gym', 'workout', 'health', 'doctor', 'medicine', 'pain', 'nutrition', 'calorie', 'fitness', 'weight', 'mental', 'psychology', 'recipe', 'food', 'cook'],
            'Education': ['learn', 'school', 'study', 'exam', 'university', 'academic', 'thesis', 'essay', 'paper', 'research', 'grade', 'course', 'lesson', 'teacher', 'student'],
            'Music': ['song', 'lyrics', 'chord', 'guitar', 'piano', 'album', 'spotify', 'rhythm', 'music', 'band', 'concert', 'compose', 'sound'],
            'Tech': ['computer', 'phone', 'ai', 'chatgpt', 'hardware', 'software', 'windows', 'mac', 'linux', 'wifi', 'internet', 'device', 'keyboard', 'mouse', 'screen'],
            'General': []
        };

        let appData = { raw: [], categories: {}, stats: {} };
        let currentViewCategory = 'General';

        // --- INIT ---
        window.onload = async () => {
             if (typeof window.electron === 'undefined') {
                console.warn("Browser Mode - No Electron API");
                document.getElementById('view-upload').classList.remove('hidden');
                return;
            }
            const savedData = await window.electron.loadState();
            if (savedData && savedData.categories && Object.keys(savedData.categories).length > 0) {
                appData = savedData;
                showOrganizer();
                renderCategoriesSidebar();
                renderConversationList('General');
            } else {
                document.getElementById('view-upload').classList.remove('hidden');
            }
        };

        // --- UPLOAD ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('bg-blue-50'); });
        dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('bg-blue-50'); });
        dropZone.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        function handleFile(file) {
            if(!file) return;
            document.getElementById('upload-ui').classList.add('hidden');
            document.getElementById('processing-ui').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                setTimeout(() => {
                    try {
                        const json = JSON.parse(e.target.result);
                        processAndCategorize(json);
                    } catch(err) { alert("Error parsing JSON file."); location.reload(); }
                }, 100);
            };
            reader.readAsText(file);
        }

        function processAndCategorize(json) {
            appData.categories = { 'General': [] };
            Object.keys(KEYWORDS).forEach(k => appData.categories[k] = []);
            
            json.forEach(item => {
                const title = (item.title || "").toLowerCase();
                let contentSnippet = "";
                if(item.mapping) {
                     try {
                        const nodes = Object.values(item.mapping);
                        const userMsg = nodes.find(n => n.message && n.message.author && n.message.author.role === 'user');
                        if (userMsg && userMsg.message.content && userMsg.message.content.parts) {
                            contentSnippet = userMsg.message.content.parts.join(" ").toLowerCase().slice(0, 300);
                        }
                     } catch(e) { }
                }
                const fullText = title + " " + contentSnippet;
                let assigned = false;
                for (const [cat, words] of Object.entries(KEYWORDS)) {
                    if (words.some(w => fullText.includes(w))) {
                        appData.categories[cat].push(createItem(item));
                        assigned = true; break;
                    }
                }
                if (!assigned) appData.categories['General'].push(createItem(item));
            });
            saveToDisk();
            showOrganizer();
            renderCategoriesSidebar();
            renderConversationList('General');
        }

        function createItem(raw) {
            return { id: raw.id || Math.random().toString(36), title: raw.title || "Untitled Chat", timestamp: raw.create_time, original: raw };
        }

        async function saveToDisk() {
             if (typeof window.electron !== 'undefined') await window.electron.saveState(appData);
        }

        async function fullReset() {
            if(confirm('Are you sure? This will delete all local data and reset the app.')) {
                 if (typeof window.electron !== 'undefined') await window.electron.resetApp();
                location.reload();
            }
        }

        // --- UI ---
        function showOrganizer() {
            document.getElementById('view-upload').classList.add('hidden');
            document.getElementById('view-organizer').classList.remove('hidden');
        }

        function renderCategoriesSidebar() {
            const list = document.getElementById('category-list');
            list.innerHTML = '';
            const cats = Object.keys(appData.categories).sort((a,b) => {
                if(a === 'General') return -1; if(b === 'General') return 1;
                return appData.categories[b].length - appData.categories[a].length;
            });
            cats.forEach(cat => {
                const count = appData.categories[cat].length;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg mb-1 cursor-pointer flex justify-between hover:bg-slate-50 ${cat === currentViewCategory ? 'bg-indigo-50 text-indigo-700 border border-indigo-100' : 'text-slate-600'}`;
                div.innerHTML = `<span class="truncate pr-2">${cat}</span><span class="bg-slate-200 text-xs px-2 py-0.5 rounded-full h-fit min-w-[1.5rem] text-center">${count}</span>`;
                div.onclick = () => { currentViewCategory = cat; renderCategoriesSidebar(); renderConversationList(cat); };
                div.ondragover = e => { e.preventDefault(); div.classList.add('bg-blue-100'); };
                div.ondragleave = e => { e.preventDefault(); div.classList.remove('bg-blue-100'); };
                div.ondrop = e => handleDrop(e, cat);
                list.appendChild(div);
            });
            document.getElementById('rule-target-select').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderConversationList(cat, filter = '') {
            const container = document.getElementById('conversation-container');
            container.innerHTML = '';
            document.getElementById('current-category-title').textContent = cat;
            const items = appData.categories[cat].filter(i => i.title.toLowerCase().includes(filter.toLowerCase()));
            document.getElementById('current-count-badge').textContent = items.length;
            if(items.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-lg shadow-sm border border-slate-200 cursor-move hover:border-blue-400 select-none transition-all group";
                el.draggable = true;
                const dateStr = item.timestamp ? new Date(item.timestamp*1000).toLocaleDateString() : '-';
                el.innerHTML = `<div class="font-semibold text-sm line-clamp-2 text-slate-700 mb-2">${item.title}</div><div class="flex justify-between items-end"><div class="text-xs text-slate-400">${dateStr}</div><div class="text-xs text-indigo-500 opacity-0 group-hover:opacity-100 font-medium">Move ‚ûî</div></div>`;
                el.ondragstart = e => e.dataTransfer.setData("text", JSON.stringify({ id: item.id, from: cat }));
                container.appendChild(el);
            });
        }

        function handleDrop(e, targetCat) {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData("text"));
                if(data.from === targetCat) return;
                const list = appData.categories[data.from];
                const idx = list.findIndex(i => i.id === data.id);
                if(idx > -1) {
                    const item = list.splice(idx, 1)[0];
                    appData.categories[targetCat].push(item);
                    saveToDisk(); renderCategoriesSidebar(); renderConversationList(currentViewCategory);
                }
            } catch(err) {}
        }

        function applySmartRule() {
            const wordRaw = document.getElementById('rule-keywords').value.toLowerCase();
            const target = document.getElementById('rule-target-select').value;
            if(!wordRaw) return;
            const words = wordRaw.split(',').map(w => w.trim()).filter(w => w);
            let count = 0;
            Object.keys(appData.categories).forEach(cat => {
                if(cat === target) return;
                for(let i = appData.categories[cat].length - 1; i >= 0; i--) {
                    const item = appData.categories[cat][i];
                    if(words.some(w => item.title.toLowerCase().includes(w))) {
                        appData.categories[cat].splice(i, 1);
                        appData.categories[target].push(item);
                        count++;
                    }
                }
            });
            saveToDisk(); closeModal('modal-smart-rule'); renderCategoriesSidebar(); renderConversationList(currentViewCategory); showToast(`${count} chats moved.`);
        }

        function addNewCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const properName = name.charAt(0).toUpperCase() + name.slice(1);
            if(appData.categories[properName]) return alert('Category already exists!');
            appData.categories[properName] = [];
            saveToDisk(); closeModal('modal-category'); renderCategoriesSidebar();
        }

        function updateExport() {
            const list = document.getElementById('export-list');
            list.innerHTML = '';
            Object.keys(appData.categories).forEach(cat => {
                if(appData.categories[cat].length === 0) return;
                const btn = document.createElement('button');
                btn.className = "bg-white p-4 rounded-lg shadow border border-slate-200 hover:bg-emerald-50 text-left transition-colors";
                btn.innerHTML = `<h3 class="font-bold text-slate-800">${cat}</h3><p class="text-sm text-emerald-600 mt-1">üìÇ Save to Desktop</p>`;
                btn.onclick = async () => {
                    if (typeof window.electron === 'undefined') return alert("Desktop App Only");
                    const res = await window.electron.exportCategory(cat, appData.categories[cat]);
                    if(res.success) alert(`Success!\nFolder: ${cat}\nFiles: ${res.count}\nPath: ${res.path}`);
                    else alert("Error: " + res.error);
                };
                list.appendChild(btn);
            });
        }
        
        function updateDashboard() {
            document.getElementById('total-stat').textContent = appData.raw.length || 0;
            const ctx = document.getElementById('pieChart').getContext('2d');
            const labels = Object.keys(appData.categories);
            const data = labels.map(l => appData.categories[l].length);
            if(window.myPie) window.myPie.destroy();
            window.myPie = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444', '#94a3b8'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function switchTab(t) {
            ['organizer', 'dashboard', 'export'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            if(t === 'export') updateExport();
            if(t === 'dashboard') updateDashboard();
        }
        function openCategoryModal() { document.getElementById('new-cat-name').value = ''; document.getElementById('modal-category').classList.remove('hidden'); setTimeout(()=>document.getElementById('modal-category').classList.remove('opacity-0'),10); document.getElementById('new-cat-name').focus(); }
        function openSmartRuleModal() { document.getElementById('modal-smart-rule').classList.remove('hidden'); setTimeout(()=>document.getElementById('modal-smart-rule').classList.remove('opacity-0'),10); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0'); setTimeout(()=>document.getElementById(id).classList.add('hidden'),300); }
        function showToast(msg) { const t = document.getElementById('toast'); if(msg) t.textContent = "‚úî " + msg; t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(()=>t.classList.add('translate-y-20', 'opacity-0'), 2000); }
        document.getElementById('search-input').addEventListener('input', e => renderConversationList(currentViewCategory, e.target.value));
    </script>
</body>
</html>